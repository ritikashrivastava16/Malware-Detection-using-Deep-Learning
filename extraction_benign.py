from pyparsing import Word, hexnums, WordEnd, Optional, alphas, alphanums
import os
import pandas as pd


most_frequent_opcodes = [
    "or",
    "call",
    "lea",
    "test",
    "xor",
    "jz",
    "jmp",
    "shl",
    "push",
    "jne",
    "pop",
    "and",
    "add",
    "je",
    "cmp",
    "sub",
    "inc",
    "mov",
    "ret",
    "retn",
    "jnz",
]

hex_integer = Word(hexnums) + WordEnd()
line = (
    ".text:"
    + hex_integer
    + Optional((hex_integer * (1,))("instructions") + Word(alphas, alphanums)("opcode"))
)


dir_list = sorted(os.listdir("Benign/asm"))
print(len(dir_list))
opcode_sequence_dictionary = dict()
data = pd.DataFrame()
start = 0  # start index of your assigned files
end = 27  # end index of your assigned files
for asm_file in dir_list:
    visited = False  # visited the text section
    opcodes = list()
    with open(os.path.join("Benign/asm", asm_file)) as source:
        try:
            for source_line in source:
                source_line = source_line.strip()
                if source_line[:5] == ".text":
                    visited = True
                    result = line.parseString(source_line)
                    if "opcode" in result:
                        # if str(result.opcode) in most_frequent_opcodes:
                        opcodes.append(result.opcode)
                elif source_line[:5] != ".text" and visited == False:
                    pass
                else:
                    break
        except:
            pass
    opcode_sequence_dictionary[asm_file] = opcodes

data = pd.DataFrame(
    {
        "filename": list(opcode_sequence_dictionary.keys()),
        "sequence": list(opcode_sequence_dictionary.values()),
    }
)
data.to_csv(f"benign_opcode_seq_{start}_{end}.csv", index=False)